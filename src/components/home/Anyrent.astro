---
const { translations } = Astro.props
const { lang } = Astro.params
import Ad from '../../assets/ad.json'
---

<div class="margin bg-blue/10 flex flex-col justify-center py-12 xl:py-24">

    <h2 class="text-4xl xl:text-5xl font-bold flex items-center justify-center text-center text-blue pb-8">
        Achieve the best
        <br />
        {translations.title}
    </h2>

    <div class="w-full flex items-center justify-center" id="time-table">
      <div class="lg:w-fit w-full [&>*]:px-2 [&>*]:py-1">
        <div class="bg-blue/50 text-white rounded-t-lg">{translations.table.title}</div>
        <div class="space-y-1 bg-blue text-white">
          <p>{translations.table.line1.title}</p>
          <p>{translations.table.line1.time}</p>
        </div>
        <div class="space-y-1 bg-green-500 text-white">
          <div>{translations.table.line2.title}</div>
          <div>{translations.table.line2.time1}</div>
          <div>{translations.table.line2.time2}</div>
        </div>
        <div class="space-y-1 bg-red-600 text-white">
          <div>{translations.table.line3.title}</div>
          <div>{translations.table.line3.time1}</div>
          <div>{translations.table.line3.time2}</div>
          <div>{translations.table.line3.time3}</div>
        </div>
      </div>
    </div>
    
    <span id="anyrent-scroll" class="relative" style={(Ad.is_active?"top: -10rem;":"top: -6rem;")}></span>
    <anyrent-iframe data-locale={lang}></anyrent-iframe>
    <script id="jedeyeScript" src="https://reservas.achieverentacar.com/themes/iframe/assets/vendor/anyrent-booking-engine.min.js"></script>

</div>

<script>

  const booknow = document.getElementsByClassName("booknow");
  const anyrent = document.getElementById("anyrent-scroll");
  const time_table = document.getElementById("time-table");
  if(booknow)
    Array.from(booknow).map((button) => {
      button.addEventListener('click', () => {
          if(anyrent)
            anyrent.scrollIntoView({
              behavior: "smooth"
            });
      });
    })

  document.addEventListener('DOMContentLoaded', () =>
  {
    const system = document.getElementById('anyrentBookingsIframe') as HTMLIFrameElement
    if (system){
      system.title = 'Anyrent Bookings System'
      system.style.borderBottomLeftRadius = "0.375rem"
      system.style.borderBottomRightRadius = "0.375rem"

      let firstTime = true;
      const anyrentSystemScroller = document.getElementById("anyrent-scroll");
      if(anyrentSystemScroller)
        window.addEventListener("message", function(event) {
          if (event.source === system.contentWindow) {
            if (event.data.type === "arIframeUrlChange") {

              let newURL = event.data.url;
              let step = newURL.split("/")[newURL.split("/").length - 1]
              console.debug("URL mudou: " + newURL);
              console.log(event.data);

              if (step == "step1") {
                time_table?.classList.add("flex")
                time_table?.classList.remove("hidden")
              }

              if (step != "step2") {
                time_table?.classList.add("hidden")
                time_table?.classList.remove("flex")
              }

              if (step == "finish") {
                fetch('https://oleoa.app.n8n.cloud/webhook/3af67b23-2599-4607-b064-b62878460169', {
                  method: 'GET'
                })
              }

              if(!firstTime){
                setTimeout(function(){
                  anyrentSystemScroller.scrollIntoView({
                    behavior: "smooth"
                  });
                }, 100)
              }
              firstTime = false;
            }
          }
        }, false);
    }
  });

</script>
